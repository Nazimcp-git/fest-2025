<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PORU '25 - Art Competition Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel processing -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .filter-btn, .view-btn, .admin-btn, .action-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active, .view-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-btn:not(.active):hover, .view-btn:not(.active):hover {
            background-color: #e0e7ff;
        }
        .date-group {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .date-header {
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .event-row {
            display: grid;
            grid-template-columns: 120px 1fr 1fr 80px;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            border-left-width: 5px;
            border-left-style: solid;
        }
        .event-row:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .event-row {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem 1.5rem;
            }
            .event-program { grid-column: 1 / -1; margin-bottom: 0.5rem; }
            .event-time { grid-column: 1 / 2; grid-row: 2 / 3;}
            .event-venue { grid-column: 2 / 3; grid-row: 2 / 3; text-align: right;}
            .event-category { display: none; }
        }

        /* Timeline Styles */
        #timeline-view { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; overflow-x: auto; }
        .timeline-container { display: flex; position: relative; min-width: 800px; }
        .time-axis { padding-right: 1rem; font-size: 0.75rem; color: #6b7280; position: relative; }
        .time-label { position: absolute; transform: translateY(-50%); white-space: nowrap; }
        .time-label::after { content: ''; position: absolute; left: 50px; right: -2000px; top: 50%; height: 1px; background-color: #e5e7eb; z-index: 0; }
        .venues-container { display: flex; flex-grow: 1; }
        .venue-col { flex: 1; border-left: 1px solid #e5e7eb; position: relative; padding: 0 0.5rem; }
        .venue-header { text-align: center; padding-bottom: 0.5rem; margin-bottom: 1rem; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
        .timeline-event { position: absolute; left: 0.5rem; right: 0.5rem; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.8rem; color: #1e1b4b; cursor: pointer; z-index: 10; overflow: hidden; border-left-width: 4px; }
        .timeline-event:hover { opacity: 0.8; }
        .current-time-line { position: absolute; width: 100%; height: 2px; background-color: #ef4444; z-index: 20; left:0; }
        .current-time-line::before { content: 'Now'; position: absolute; left: -35px; top: -8px; background-color: #ef4444; color: white; padding: 0px 5px; border-radius: 4px; font-size: 0.75rem; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; }
        
        /* Admin Panel Styles */
        #admin-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">PORU '25</h1>
            <p class="text-lg text-gray-600 mt-2">Prevail, Overcome, Rise, Unite</p>
            <p class="text-md text-gray-500">Darunnajath Islamic Complex, Vallapuzha</p>
            <p class="text-xl font-semibold text-gray-700 mt-4">Stage Items Category Time Table</p>
        </header>

        <!-- Admin Section -->
        <div class="mb-8 bg-white rounded-lg shadow-md">
            <button id="admin-toggle-btn" class="admin-btn w-full p-3 text-left font-semibold text-gray-700 hover:bg-gray-50 rounded-t-lg">Admin Panel</button>
            <div id="admin-panel" class="p-4 border-t border-gray-200">
                <div id="admin-notification" class="mb-4 hidden p-3 rounded-md text-white"></div>
                <!-- Single Program Form -->
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Add Single Program</h3>
                <form id="add-program-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2"><label for="event-date" class="block text-sm font-medium text-gray-700">Event Date</label><input type="date" id="event-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label for="event-category" class="block text-sm font-medium text-gray-700">Category</label><select id="event-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"><option>BIDAYA</option><option>ULA</option><option>THANIYA</option><option>THANAWIYYA</option><option>ALIYA</option><option>KULLIYYA</option></select></div>
                    <div><label for="event-program" class="block text-sm font-medium text-gray-700">Program Name</label><input type="text" id="event-program" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label for="event-time" class="block text-sm font-medium text-gray-700">Time (e.g., 9-10 AM)</label><input type="text" id="event-time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label for="event-venue" class="block text-sm font-medium text-gray-700">Venue</label><input type="number" id="event-venue" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Program</button></div>
                </form>

                <!-- Bulk Upload Section -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Bulk Upload from Excel</h3>
                    <p class="text-sm text-gray-600 mb-4">Upload an Excel file (.xlsx) to replace the entire schedule. Download the template to ensure correct formatting.</p>
                    <div class="flex flex-col sm:flex-row gap-4"><button id="download-template-btn" class="action-btn flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">Download Template</button></div>
                    <div class="mt-4"><label for="excel-file-input" class="block text-sm font-medium text-gray-700 mb-1">Select Excel File</label><input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"><button id="upload-schedule-btn" class="action-btn mt-2 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Upload and Replace Schedule</button></div>
                </div>
            </div>
        </div>

        <!-- Controls: Filters & View Switcher -->
        <div class="mb-8 p-4 bg-white rounded-lg shadow-md space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                 <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Filter by Date:</h3><div id="date-filters" class="flex flex-wrap gap-2"></div></div>
                 <div class="mt-4 md:mt-0 md:ml-6"><h3 class="text-lg font-semibold text-gray-700 mb-2">View:</h3><div id="view-switcher" class="flex gap-2"><button class="view-btn active px-4 py-2 rounded-md text-sm font-medium border" data-view="list">List</button><button class="view-btn px-4 py-2 rounded-md text-sm font-medium border" data-view="timeline">Timeline</button></div></div>
            </div>
             <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Filter by Time:</h3>
                <div class="flex items-center gap-2">
                    <input type="time" id="time-filter" class="block w-40 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <button id="clear-time-btn" class="text-sm text-gray-600 hover:text-indigo-600">Clear</button>
                </div>
            </div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Filter by Category:</h3><div id="category-filters" class="flex flex-wrap gap-2"></div></div>
            <div><h3 class="text-lg font-semibold text-gray-700 mb-2">Filter by Venue:</h3><div id="venue-filters" class="flex flex-wrap gap-2"></div></div>
        </div>

        <!-- Schedule Container -->
        <div id="schedule-list-view"></div>
        <div id="timeline-view" class="hidden"></div>
        <div id="loading-spinner" class="text-center py-12"><p class="text-lg text-gray-500">Loading Schedule...</p></div>
        <div id="no-results" class="hidden text-center py-12"><p class="text-xl text-gray-500">No events found for the selected filters.</p></div>
    </div>
    
    <!-- Modal -->
    <div id="event-modal" class="modal-overlay hidden">
        <div class="modal-content"><h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h2><p id="modal-category" class="text-lg text-indigo-600 font-semibold mb-4"></p><p class="text-gray-600 mb-2"><span class="font-semibold">Time:</span> <span id="modal-time"></span></p><p class="text-gray-600 mb-4"><span class="font-semibold">Venue:</span> <span id="modal-venue"></span></p><button id="modal-close" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Close</button></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = { apiKey: "AIzaSyBXJ_RnfjUDi7qPDATWVnS5lSFw6jVRYgo", authDomain: "shopping-e284c.firebaseapp.com", databaseURL: "https://shopping-e284c-default-rtdb.firebaseio.com", projectId: "shopping-e284c", storageBucket: "shopping-e284c.appspot.com", messagingSenderId: "248274428739", appId: "1:248274428739:web:fc30dd9eb1ef83f610c5f6", measurementId: "G-ZXZCK9BW7T" };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const scheduleRef = database.ref('schedule');

        // --- Global State ---
        let liveScheduleData = {};
        let activeDateFilter = 'all';
        let activeCategoryFilter = 'all';
        let activeVenueFilter = 'all';
        let activeTimeFilter = null;
        let currentView = 'list';
        let currentTimeInterval;

        // --- DOM Elements ---
        const dateFiltersContainer = document.getElementById('date-filters');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const venueFiltersContainer = document.getElementById('venue-filters');
        const timeFilterInput = document.getElementById('time-filter');
        const clearTimeBtn = document.getElementById('clear-time-btn');
        const scheduleListView = document.getElementById('schedule-list-view');
        const timelineView = document.getElementById('timeline-view');
        const viewSwitcher = document.getElementById('view-switcher');
        const noResults = document.getElementById('no-results');
        const loadingSpinner = document.getElementById('loading-spinner');
        const modal = document.getElementById('event-modal');
        const adminToggleBtn = document.getElementById('admin-toggle-btn');
        const adminPanel = document.getElementById('admin-panel');
        
        const categoryStyles = {
            "BIDAYA":     { bg: 'bg-red-200', border: 'border-red-500', hex: '#ef4444' },
            "ULA":        { bg: 'bg-blue-200', border: 'border-blue-500', hex: '#3b82f6' },
            "THANIYA":    { bg: 'bg-green-200', border: 'border-green-500', hex: '#22c55e' },
            "THANAWIYYA": { bg: 'bg-yellow-200', border: 'border-yellow-500', hex: '#eab308' },
            "ALIYA":      { bg: 'bg-purple-200', border: 'border-purple-500', hex: '#8b5cf6' },
            "KULLIYYA":   { bg: 'bg-pink-200', border: 'border-pink-500', hex: '#ec4899' },
            "default":    { bg: 'bg-gray-200', border: 'border-gray-500', hex: '#6b7280' }
        };

        // --- Initialization ---
        function initialize() {
            setupEventListeners();
            fetchDataAndRender();
        }

        function fetchDataAndRender() {
            scheduleRef.on('value', (snapshot) => {
                loadingSpinner.classList.add('hidden');
                liveScheduleData = snapshot.val() || {};
                createDateFilters();
                createCategoryFilters();
                createVenueFilters();
                render();
            }, (error) => {
                console.error(error);
                loadingSpinner.innerHTML = `<p class="text-lg text-red-500">Error loading schedule.</p>`;
            });
        }
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
            dateFiltersContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { activeDateFilter = e.target.dataset.filter; updateActiveButton(dateFiltersContainer, e.target); render(); } });
            categoryFiltersContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { activeCategoryFilter = e.target.dataset.filter; updateActiveButton(categoryFiltersContainer, e.target); render(); } });
            venueFiltersContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { activeVenueFilter = e.target.dataset.filter; updateActiveButton(venueFiltersContainer, e.target); render(); } });
            viewSwitcher.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { currentView = e.target.dataset.view; updateActiveButton(viewSwitcher, e.target); render(); } });
            timeFilterInput.addEventListener('change', () => { activeTimeFilter = timeFilterInput.value; render(); });
            clearTimeBtn.addEventListener('click', () => { activeTimeFilter = null; timeFilterInput.value = ''; render(); });
            document.getElementById('modal-close').addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
            adminToggleBtn.addEventListener('click', () => { adminPanel.style.maxHeight = adminPanel.style.maxHeight ? null : adminPanel.scrollHeight + "px"; });
            document.getElementById('add-program-form').addEventListener('submit', handleAddProgram);
            document.getElementById('download-template-btn').addEventListener('click', handleDownloadTemplate);
            document.getElementById('upload-schedule-btn').addEventListener('click', handleUploadSchedule);
        }
        
        // --- Rendering Logic ---
        function render() {
            if (currentView === 'list') {
                scheduleListView.classList.remove('hidden');
                timelineView.classList.add('hidden');
                renderScheduleListView();
            } else {
                scheduleListView.classList.add('hidden');
                timelineView.classList.remove('hidden');
                renderTimelineView();
            }
        }
        
        // --- Filter Creation ---
        function createDateFilters() {
            const dates = ['all', ...Object.keys(liveScheduleData).sort()];
            dateFiltersContainer.innerHTML = dates.map(date => `<button class="filter-btn ${date === activeDateFilter ? 'active' : ''} px-4 py-2 rounded-md text-sm font-medium border" data-filter="${date}">${date === 'all' ? 'All Dates' : date.split(' ')[0]}</button>`).join('');
        }
        
        function createCategoryFilters() {
            const categories = new Set(['all']);
            Object.values(liveScheduleData).forEach(day => Object.keys(day).forEach(cat => categories.add(cat)));
            const sortedCategories = Array.from(categories).sort((a, b) => a === 'all' ? -1 : b === 'all' ? 1 : a.localeCompare(b));
            categoryFiltersContainer.innerHTML = sortedCategories.map(category => `<button class="filter-btn ${category === activeCategoryFilter ? 'active' : ''} px-4 py-2 rounded-md text-sm font-medium border" data-filter="${category}">${category.charAt(0).toUpperCase() + category.slice(1)}</button>`).join('');
        }

        function createVenueFilters() {
            const venues = new Set(['all']);
            Object.values(liveScheduleData).forEach(day => Object.values(day).forEach(cat => Object.values(cat).forEach(event => venues.add(event.venue))));
            const sortedVenues = Array.from(venues).sort((a, b) => a === 'all' ? -1 : b === 'all' ? 1 : a - b);
            venueFiltersContainer.innerHTML = sortedVenues.map(venue => `<button class="filter-btn ${venue == activeVenueFilter ? 'active' : ''} px-4 py-2 rounded-md text-sm font-medium border" data-filter="${venue}">${venue === 'all' ? 'All Venues' : `Venue ${venue}`}</button>`).join('');
        }

        function updateActiveButton(container, activeButton) {
             container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
             activeButton.classList.add('active');
        }

        // --- List View Logic ---
        function renderScheduleListView() {
            scheduleListView.innerHTML = '';
            let hasAnyEvents = false;
            const filteredDates = activeDateFilter === 'all' ? Object.keys(liveScheduleData).sort() : [activeDateFilter];
            const filterTimeInMinutes = activeTimeFilter ? parseTimeToMinutes(activeTimeFilter) : null;

            for (const date of filteredDates) {
                if (!liveScheduleData[date]) continue;
                let dailyEvents = [];
                for (const category in liveScheduleData[date]) {
                    for (const eventId in liveScheduleData[date][category]) {
                        const event = liveScheduleData[date][category][eventId];
                        const eventTimeRange = getEventTimeRange(event.time);
                        // Apply filters
                        if ((activeCategoryFilter === 'all' || category === activeCategoryFilter) &&
                            (activeVenueFilter === 'all' || event.venue == activeVenueFilter) &&
                            (filterTimeInMinutes === null || (filterTimeInMinutes >= eventTimeRange.start && filterTimeInMinutes < eventTimeRange.end))) {
                            dailyEvents.push({ ...event, category });
                        }
                    }
                }
                
                if (dailyEvents.length > 0) {
                    hasAnyEvents = true;
                    dailyEvents.sort((a, b) => parseTimeToMinutes(a.time) - parseTimeToMinutes(b.time));
                    
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'date-group';
                    const eventRowsHTML = dailyEvents.map(event => {
                        const style = categoryStyles[event.category] || categoryStyles.default;
                        return `
                        <div class="event-row" style="border-left-color: ${style.hex};">
                            <div class="event-time font-semibold text-gray-800">${event.time}</div>
                            <div class="event-program text-gray-700">${event.program}</div>
                            <div class="event-category text-sm font-medium" style="color: ${style.hex};">${event.category}</div>
                            <div class="event-venue text-right">
                                <p class="text-sm text-gray-500">Venue</p>
                                <p class="font-bold text-lg text-indigo-600">${event.venue}</p>
                            </div>
                        </div>`;
                    }).join('');
                        
                    dateGroup.innerHTML = `<div class="date-header"><h2 class="text-2xl font-bold text-gray-700">${date.split(' ')[0]}</h2><p class="text-md text-gray-500">${date.split(' ')[1]}</p></div><div>${eventRowsHTML}</div>`;
                    scheduleListView.appendChild(dateGroup);
                }
            }
            noResults.classList.toggle('hidden', !hasAnyEvents);
        }

        // --- Timeline View Logic ---
        const timelineStartHour = 6, timelineEndHour = 22;
        function renderTimelineView() {
            timelineView.innerHTML = '';
            if (activeDateFilter === 'all') { timelineView.innerHTML = `<div class="text-center p-8 text-gray-600">Please select a single date to see the timeline view.</div>`; return; }
            const daySchedule = liveScheduleData[activeDateFilter];
            if (!daySchedule) { timelineView.innerHTML = `<div class="text-center p-8 text-gray-600">No schedule available for this date.</div>`; return; }
            const venues = new Set();
            Object.values(daySchedule).forEach(cat => Object.values(cat).forEach(evt => venues.add(evt.venue)));
            let sortedVenues = activeVenueFilter === 'all' ? Array.from(venues).sort((a, b) => a - b) : [parseInt(activeVenueFilter)];
            if (sortedVenues.length === 0 || (activeVenueFilter !=='all' && !venues.has(parseInt(activeVenueFilter)))) { timelineView.innerHTML = `<div class="text-center p-8 text-gray-600">No events for selected venue.</div>`; return; }

            const timelineContainer = document.createElement('div'); timelineContainer.className = 'timeline-container';
            const timeAxis = document.createElement('div'); timeAxis.className = 'time-axis';
            for (let h = timelineStartHour; h <= timelineEndHour; h++) { timeAxis.innerHTML += `<div class="time-label" style="top: ${((h - timelineStartHour) / (timelineEndHour - timelineStartHour)) * 100}%">${h % 12 || 12} ${h >= 12 ? 'PM' : 'AM'}</div>`; }
            const venuesContainer = document.createElement('div'); venuesContainer.className = 'venues-container';
            sortedVenues.forEach(v => { venuesContainer.innerHTML += `<div class="venue-col"><div class="venue-header">Venue ${v}</div></div>`; });
            timelineContainer.append(timeAxis, venuesContainer);
            timelineView.appendChild(timelineContainer);
            
            let hasEvents = false;
            const filteredCategories = activeCategoryFilter === 'all' ? Object.keys(daySchedule) : [activeCategoryFilter];
            filteredCategories.forEach(category => {
                if (!daySchedule[category]) return;
                Object.values(daySchedule[category]).forEach(event => {
                    if (activeVenueFilter !== 'all' && event.venue != activeVenueFilter) return;
                    hasEvents = true;
                    const range = getEventTimeRange(event.time);
                    const top = timeToPercentage(range.start);
                    const height = Math.max(timeToPercentage(range.end) - top, 2);
                    const eventEl = document.createElement('div');
                    const style = categoryStyles[category] || categoryStyles.default;
                    eventEl.className = `timeline-event ${style.bg}`;
                    eventEl.style.cssText = `top:${top}%; height:${height}%; border-left-color: ${style.hex};`;
                    eventEl.innerHTML = `<p class="font-bold truncate">${event.program}</p><p>${category}</p>`;
                    eventEl.addEventListener('click', () => showModal(event, category, activeDateFilter));
                    const venueIndex = sortedVenues.indexOf(event.venue);
                    if (venueIndex !== -1) venuesContainer.children[venueIndex].appendChild(eventEl);
                });
            });
            noResults.classList.toggle('hidden', !hasEvents);
            if (!hasEvents) timelineView.innerHTML = `<div class="text-center p-8 text-gray-600">No events found.</div>`;
            clearInterval(currentTimeInterval); updateCurrentTimeIndicator(); currentTimeInterval = setInterval(updateCurrentTimeIndicator, 60000);
        }
        
        // --- Helper functions ---
        function parseTimeToMinutes(timeStr) { if(!timeStr) return 0; const firstTime = timeStr.split('-')[0].trim(); let time = firstTime.replace(/\s/g, '').toUpperCase(); const period = time.includes('PM') ? 'PM' : 'AM'; let [hour, minute] = time.replace('AM', '').replace('PM', '').split(/[:.]/).map(s => parseInt(s) || 0); if (isNaN(hour)) return 0; if (period === 'PM' && hour !== 12) hour += 12; if (period === 'AM' && hour === 12) hour = 0; return hour * 60 + (minute || 0); }
        function getEventTimeRange(timeStr) { if (!timeStr) return { start: 0, end: 0 }; const parts = timeStr.split('-').map(s => s.trim()); const startMinutes = parseTimeToMinutes(parts[0]); let endMinutes; if (parts.length > 1) { const startWasPM = parts[0].toUpperCase().includes('PM'); let endStr = parts[1]; if (!endStr.toUpperCase().includes('AM') && !endStr.toUpperCase().includes('PM')) { endStr += startWasPM ? " PM" : " AM"; } endMinutes = parseTimeToMinutes(endStr); if (endMinutes < startMinutes) endMinutes += 12 * 60; } else { endMinutes = startMinutes + 45; } return { start: startMinutes, end: endMinutes }; }
        function timeToPercentage(minutes) { const totalMinutes = (timelineEndHour - timelineStartHour) * 60; const eventMinutes = minutes - (timelineStartHour * 60); return (eventMinutes / totalMinutes) * 100; }
        function showModal(event, category, date) { document.getElementById('modal-title').textContent = event.program; document.getElementById('modal-category').textContent = category; document.getElementById('modal-time').textContent = `${event.time} on ${date.split(' ')[0]}`; document.getElementById('modal-venue').textContent = event.venue; modal.classList.remove('hidden'); }
        
        // --- Admin and Upload Functions ---
        function handleAddProgram(e){ e.preventDefault(); const dateInput = document.getElementById("event-date").value; const category = document.getElementById("event-category").value; const program = document.getElementById("event-program").value; const time = document.getElementById("event-time").value; const venue = document.getElementById("event-venue").value; if(!dateInput || !category || !program || !time || !venue){ showAdminNotification("Please fill all fields.","red"); return; } const dateObj = new Date(dateInput + 'T00:00:00'); const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' }).toUpperCase(); const formattedDate = `${dateObj.getDate().toString().padStart(2, '0')}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}-${dateObj.getFullYear()} ${day}`; const newProgram = { program, time, venue: parseInt(venue) }; database.ref(`schedule/${formattedDate}/${category}`).push(newProgram).then(() => { showAdminNotification('Program added successfully!', 'green'); document.getElementById('add-program-form').reset(); }).catch(error => showAdminNotification(`Error: ${error.message}`, 'red')); }
        function showAdminNotification(message, color){ const notification = document.getElementById("admin-notification"); notification.className = `mb-4 p-3 rounded-md text-white bg-${color}-500`; notification.textContent = message; notification.classList.remove("hidden"); setTimeout(() => notification.classList.add("hidden"), 4000); }
        function handleDownloadTemplate(){ const sampleData = [{ Date: '2025-10-25', Category: 'BIDAYA', 'Program Name': 'Sample Program', Time: '9-10 AM', Venue: 1 }]; const worksheet = XLSX.utils.json_to_sheet(sampleData); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Schedule"); XLSX.writeFile(workbook, "schedule_template.xlsx"); }
        
        function handleUploadSchedule() {
            const fileInput = document.getElementById("excel-file-input");
            const file = fileInput.files[0];
            if (!file) {
                showAdminNotification("Please select an Excel file first.", "red");
                return;
            }
            const uploadBtn = document.getElementById("upload-schedule-btn");
            uploadBtn.disabled = true;
            uploadBtn.textContent = "Processing...";

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array", cellDates: true });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) throw new Error("Excel file is empty.");
                    
                    const requiredColumns = ['Date', 'Category', 'Program Name', 'Time', 'Venue'];
                    if (!requiredColumns.every(col => jsonData[0].hasOwnProperty(col))) {
                        throw new Error(`Missing required columns. Please use the template.`);
                    }

                    const newSchedule = {};
                    jsonData.forEach((row, index) => {
                        const dateValue = row.Date;
                        let dateObj;

                        if (dateValue instanceof Date) {
                            dateObj = dateValue;
                        } 
                        else if (typeof dateValue === 'string') {
                            dateObj = new Date(dateValue + 'T00:00:00'); 
                        }

                        if (!dateObj || isNaN(dateObj.getTime())) {
                            console.warn(`Skipping row #${index + 2} due to invalid date format: "${row.Date}"`);
                            return; 
                        }

                        const day = dateObj.getDate().toString().padStart(2, '0');
                        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        const year = dateObj.getFullYear();
                        const formattedDateStr = `${day}-${month}-${year}`;
                        const dayOfWeek = dateObj.toLocaleDateString('en-GB', { weekday: 'long' }).toUpperCase();
                        const formattedDateKey = `${formattedDateStr} ${dayOfWeek}`;

                        const category = String(row.Category || '').trim();
                        const programData = {
                            program: String(row['Program Name'] || '').trim(),
                            time: String(row.Time || '').trim(),
                            venue: parseInt(row.Venue, 10)
                        };

                        if (!category || !programData.program || !programData.time || isNaN(programData.venue)) {
                            console.warn(`Skipping row #${index + 2} due to missing data.`);
                            return;
                        }

                        if (!newSchedule[formattedDateKey]) newSchedule[formattedDateKey] = {};
                        if (!newSchedule[formattedDateKey][category]) newSchedule[formattedDateKey][category] = {};
                        
                        const programId = database.ref().push().key;
                        newSchedule[formattedDateKey][category][programId] = programData;
                    });
                    
                     if (Object.keys(newSchedule).length === 0 && jsonData.length > 0) {
                        throw new Error("Could not process any valid rows. Please check file for errors, especially in the 'Date' column.");
                    }

                    scheduleRef.set(newSchedule)
                        .then(() => showAdminNotification('Schedule successfully uploaded!', 'green'))
                        .catch(error => { throw error; });

                } catch (error) {
                    showAdminNotification(`Upload failed: ${error.message}`, 'red');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload and Replace Schedule';
                    fileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateCurrentTimeIndicator() {
            const now = new Date();
            const todayKey = Object.keys(liveScheduleData).find(key => {
                const [day, month, year] = key.split(' ')[0].split('-').map(Number);
                const scheduleDate = new Date(year, month - 1, day);
                return now.toDateString() === scheduleDate.toDateString();
            });

            let existingLine = document.querySelector(".current-time-line");
            if (existingLine) existingLine.remove();

            if ((activeDateFilter === todayKey || (activeDateFilter === 'all' && todayKey))) {
                const position = timeToPercentage(now.getHours() * 60 + now.getMinutes());
                if (position >= 0 && position <= 100) {
                    const timelineContainer = document.querySelector("#timeline-view .timeline-container");
                    if (timelineContainer) {
                        const timeLine = document.createElement('div');
                        timeLine.className = 'current-time-line';
                        timeLine.style.top = `${position}%`;
                        timelineContainer.appendChild(timeLine);
                    }
                }
            }
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

